<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/chart-elements/chart-line.html">

<dom-module id="notebooks-reports">

  <template>

    <style>
      :host {
        display: block;
        padding: 10px;
      }
      .card {
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        padding: 16px;
        margin: 24px;
        border-radius: 5px;
        background-color: #fff;
        color: #757575;
      }
      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      #dialog {
        height: 100vh;
        width: 60vw;
        margin-bottom: 10vh;
      }
      #dialog-scrollable {
        height: 80vh;
        margin-bottom: 10vh;
      }
      #dialog-scrollable p {
        margin-bottom: 10vh;
      }
      chart-line {
        width: 50vw;
        height: 100vh;
      }
    </style>

    <div id="content">
      <paper-dialog id="dialog" horizontal-align="left" vertical-align="top">
        <h2>Reports for [[selectedFileName]]</h2>
        <paper-dialog-scrollable id="dialog-scrollable">

          <template is="dom-repeat" items="[[chartDataFinal]]">
            <chart-line data="[[item]]"></chart-line>
          </template>

        </paper-dialog-scrollable>
      </paper-dialog>

      <div class="card">
        <vaadin-grid id="grid" on-selected-items-changed="gridSelectedItemsChanged">
          <table>
            <colgroup>
              <col name="fileName"/>
            </colgroup>
          </table>
        </vaadin-grid>
      </div>

      <iron-ajax id="lsAjax"
                 method="GET"
                 content-type="text/plain"
                 handle-as="text"
                 on-response="receivedLsResponse"
                 auto></iron-ajax>
       <iron-ajax id="fileContentsAjax"
                  method="GET"
                  content-type="text/plain"
                  handle-as="text"
                  on-response="receivedFileContentResponse" auto></iron-ajax>
    </div>
  </template>

  <script>
    var InitiatedRunMarker = "**** INITIATED A RUN ****";
    var FinishedRunMarker = "**** FINISHED A RUN ****";
    var Colors = [
      { opacityOn: "rgba(220,220,220,0.2)", opacityOff: "rgba(220,220,220,1)" },
      { opacityOn: "rgba(151,187,205,0.2)", opacityOff: "rgba(151,187,205,1)" }
    ];
    var ColorIdx = 0;

    Polymer({
      is: 'notebooks-reports',
      properties: {
        fileContentsPage: {
          type: Number
        },
        selectedFileName: {
          type: String
        },
        chartData: {
          type: Object
        },
        chartDataFinal: {
          type: Object
        }
      },
      ready: function() {
        this.$.lsAjax.url = window.location.origin + "/disco/code/ls";
      },
      receivedLsResponse: function(e) {
        var response = e.detail.response.replace(/\"/g, "");
        var fileNames = response.split(", ");
        fileNames.pop();
        var files = [];
        for (var i = 0; i < fileNames.length; i++) {
          var fileName = fileNames[i];
          files.push({ "fileName": fileName });
        }
        var grid = this.$.grid;
        grid.items = files;
      },
      receivedFileContentResponse: function(e) {
        var json = JSON.parse(e.detail.response);
        var contents = json.contents;
        var isLastPage = json.isLastPage;

        this.parseData(contents);
        this.fileContentsPage = this.fileContentsPage + 1;

        if (!isLastPage) {
          this.$.fileContentsAjax.url = window.location.origin + "/disco/code/" + this.selectedFileName + "?page=" + this.fileContentsPage;
        } else {
          this.chartDataFinal = this.chartData;
          this.openDialog();
          this.$.grid.selection.clear();
        }
      },
      parseData: function(contents) {
        for (var i = 0; i < contents.length; i++) {
          // line is like ('13:37:40.132556', ' ', u'JobA@5c4:46dd4:1c664', ' ', 0)
          var line = contents[i];

          if (line == InitiatedRunMarker) {
            this.chartData.push({labels: [], datasets: []});
          } else if (line == FinishedRunMarker) {
            // complement the chartData datasets with zeros
            var labelsQuantity = this.chartData[this.chartData.length - 1].labels.length;
            for (var j = 0; j < this.chartData.length; j++) {
              var chart = this.chartData[j];
              for (var k = 0; k < chart.datasets.length; k++) {
                var dataset = chart.datasets[k];
                for (var l = dataset.data.length; l < labelsQuantity; l++) {
                  dataset.data.push(0);
                }
              }
            }
          } else {
            // turn line into something like ["13:37:40.132556", "", "JobA@5c4:46dd4:1c664", "", "0"]
            line = line.replace(/u\'|\'|\(|\)|\s/g, "").split(",")

            var time = line[0].split(".")[0];  // => "13:37:40"
            var jobName = line[2];             // => "JobA@5c4:46dd4:1c664"
            var nodes = parseInt(line[4]);     // => 0

            var lastChartData = this.chartData[this.chartData.length - 1];

            // find or create a label entry
            if (lastChartData.labels.length > 0) {
              var lastLabel = lastChartData.labels[lastChartData.labels.length - 1];
              if (lastLabel != time) {
                lastChartData.labels.push(time);
              }
            } else {
              lastChartData.labels.push(time);
            }

            // find or create a dataset entry
            var dataset = null;
            for (var j = 0; j < lastChartData.datasets.length; j++) {
              var d = lastChartData.datasets[j];
              if (d.label == jobName) {
                dataset = d;
                break;
              }
            }
            if (dataset == null) {
              var color = Colors[ColorIdx];
              ColorIdx = (ColorIdx + 1) % Colors.length;

              // initialize the data to have zeros for the moment the job wasn't running yet.
              var data = [];
              for (var k = 0; k < lastChartData.labels.length - 1; k++) {
                data.push(0);
              }
              data.push(nodes);

              dataset = {
                label: jobName,
                backgroundColor: color.opacityOn,
                borderColor: color.opacityOff,
                borderWidth: 1,
                pointBackgroundColor: color.opacityOff,
                pointBorderColor: "#fff",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: color.opacityOff,
                data: data
              };

              lastChartData.datasets.push(dataset);
            } else {
              dataset.data.push(nodes);
            }

          }
        }
        // this.chartData = [{
        //   labels: ["January", "February", "March", "April", "May", "June", "July"],
        //   datasets: [
        //     {
        //       label: "My First dataset",
        //       backgroundColor: "rgba(220,220,220,0.2)",
        //       borderColor: "rgba(220,220,220,1)",
        //       borderWidth: 1,
        //       pointBackgroundColor: "rgba(220,220,220,1)",
        //       pointBorderColor: "#fff",
        //       pointHoverBackgroundColor: "#fff",
        //       pointHoverBorderColor: "rgba(220,220,220,1)",
        //       data: [65, 59, 80, 81, 56, 55, 40]
        //     },
        //     {
        //       label: "My Second dataset",
        //       backgroundColor: "rgba(151,187,205,0.2)",
        //       borderColor: "rgba(151,187,205,1)",
        //       borderWidth: 1,
        //       pointBackgroundColor: "rgba(151,187,205,1)",
        //       pointBorderColor: "#fff",
        //       pointHighlightFill: "#fff",
        //       pointHoverBorderColor: "rgba(151,187,205,1)",
        //       data: [28, 48, 40, 19, 86, 27, 90]
        //     }
        //   ]
        // },
        // {
        //   labels: ["January", "February", "March", "April", "May", "June", "July"],
        //   datasets: [
        //     {
        //       label: "My First dataset",
        //       backgroundColor: "rgba(220,220,220,0.2)",
        //       borderColor: "rgba(220,220,220,1)",
        //       borderWidth: 1,
        //       pointBackgroundColor: "rgba(220,220,220,1)",
        //       pointBorderColor: "#fff",
        //       pointHoverBackgroundColor: "#fff",
        //       pointHoverBorderColor: "rgba(220,220,220,1)",
        //       data: [65, 59, 80, 81, 56, 55, 40]
        //     },
        //     {
        //       label: "My Second dataset",
        //       backgroundColor: "rgba(151,187,205,0.2)",
        //       borderColor: "rgba(151,187,205,1)",
        //       borderWidth: 1,
        //       pointBackgroundColor: "rgba(151,187,205,1)",
        //       pointBorderColor: "#fff",
        //       pointHighlightFill: "#fff",
        //       pointHoverBorderColor: "rgba(151,187,205,1)",
        //       data: [28, 48, 40, 19, 86, 27, 90]
        //     }
        //   ]
        // }];
      },
      openDialog: function(e) {
        this.$.dialog.positionTarget = this.$.content;
        this.$.dialog.open();
      },
      gridSelectedItemsChanged: function(e) {
        var selectedFileIndex = this.$.grid.selection.selected()[0];
        if (selectedFileIndex != undefined) {
          this.selectedFileName = this.$.grid.items[selectedFileIndex].fileName;
          this.fileContentsPage = 1;
          this.chartData = [];
          this.$.fileContentsAjax.url = window.location.origin + "/disco/code/" + this.selectedFileName + "?page=" + this.fileContentsPage;
        }
      }
    });

  </script>

</dom-module>
